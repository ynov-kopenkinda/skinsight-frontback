name: CI

on:
  pull_request:
    branches: ["*"]
  push:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to run the workflow on"
        required: true
        default: "main"

jobs:
  setup-project:
    name: Setup & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - uses: ./.github/workflows/setup
  formatting:
    needs: setup-project
    name: Run Code Formatting Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - uses: ./.github/workflows/setup
      - name: Run Prettier
        run: pnpm turbo format
  typechecking:
    needs: setup-project
    name: Run Typechecking Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - uses: ./.github/workflows/setup
      - name: Run Typechecking
        run: pnpm turbo typecheck
  linting:
    needs: setup-project
    name: Run Code Quality Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - uses: ./.github/workflows/setup
      - name: Run ESLint
        run: pnpm turbo lint
  sonar:
    needs: ["linting"]
    name: Run SonarQube
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - uses: ./.github/workflows/setup
      - name: Run sonarqube
        run: echo "Sonar impl here"
  build:
    needs: ["linting", "security", "typechecking"]
    name: Run Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - uses: ./.github/workflows/setup
      - name: Run build
        run: pnpm turbo build
  security:
    needs: ["setup-project"]
    name: Run Security Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - uses: ./.github/workflows/setup
      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --sarif-file-output=snyk.sarif
      - name: Upload result to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: snyk.sarif
